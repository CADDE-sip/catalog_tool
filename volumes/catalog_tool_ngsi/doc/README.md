# カタログ作成ツール NGSI連携コンテナ

## 概要
NGSI連携コンテナでは、以下の機能をカタログ作成ツールの一部として提供しています。

 - NGSIデータモデルの入力支援機能<br>
NGSIデータモデルの候補をデータ管理サーバ（NGSIサーバ）から実際のNGSIデータをもとに作成する機能です。
 - NGSIデータ取り込み機能<br>
 NGSIデータにおけるカタログ項目の入力を支援するためにデータ管理サーバ（NGSIサーバ）から実際のNGSIデータを取り込む機能です。
 - NGSI原本データ生成機能<br>
 CADDE内の来歴管理機能においてNGSIデータの原本を保証するために、原本データを生成する機能です。

<br>
本機能はカタログ作成ツールの一部であるため、本機能を使用する場合は、カタログ作成ツールの構築時に本機能も構築する必要があります。

## システム構成図
NGSI連携コンテナを使用したカタログツールのシステム構成を下記に示します。
![Alt text](catalog_ngsi.png?raw=true "Title")<br>

## 前提条件
NGSI連携コンテナの前提条件を示します。<br>

 - NGSI連携コンテナはカタログ作成ツールを構成するコンテナの１つであり、カタログ作成ツールと同じホストで起動してください。
 - 返却されるデータモデルに含まれる属性は、参考値として使用するvalueや metadataが存在しない場合があります。
 - 実際のNGSIデータはAPIで返却されるデータモデルに含まれない属性またはメタデータを持つデータが存在する可能性があります。
 - 認可を必要としないデータでは、NGSIデータ種別、NGSIテナント、NGSIサービスパスの3項目が一致するカタログが複数存在する場合、交換実績の記録が行えないため配信のダウンロードURLにデータ取得条件を含めたカタログは作成できません。
　認可を必要としないデータの配信のダウンロードURLは「/v2/entities?type=<データ種別>」の形式としてください。


## 構築手順
本機能はカタログ作成ツールの構築時に同時に構築されます。<br>

1. ソースの構成 <br>
NGSI連携コンテナのソースを展開し、カタログ作成ツールの volumesディレクトリにコピーしてください。
```
tar -xvf catalog_ngsi.tar.gz 
cp -a catalog_ngsi cti-catalog-regist-tool/volumes/
```

2. Dockerファイルの修正 <br>
NGSI連携コンテナを起動するために、docker-compose.ymlを修正します。<br>
docker-compose.ymlファイルの末尾に以下の記載を追加してください。
```
  catalog_tool_ngsi:
    build: ./volumes/catalog_tool_ngsi
    image: ngsi
    hostname: catalog-tool-ngsi
    container_name: catalog-tool-ngsi
    restart: always
    ports:
      - "18080:18080"
    tty: true
    volumes:
      - "./volumes/catalog_tool_ngsi:/code"
    command: ['python3', '-m', 'swagger_server']
```

3. コンフィグファイルの設定
NGSIサーバへアクセスするための設定をコンフィグファイルに記載します。コンフィグファイルの設定の詳細は「コンフィグファイル」を参照してください。

4. カタログ作成ツールを起動します。

## コンフィグファイル
本機能で使用するコンフィグファイルの詳細を記載します。<br>
コンフィグファイルでは、NGSIサーバの認証方法の設定およびNGSIデータの取得に関する設定を行います。<br>
コンフィグファイルは以下に格納されています。<br>

- config.json
  <br>catalog_ngsi/swagger_server/configs<br>

(1) NGSIサーバの認証方法の設定およびNGSIデータの取得設定<br>
(1-1) 固定のアクセストークンでNGSIサーバに接続する場合

  | 設定パラメータ    | 概要                                                                                                   |
  | :---------------- | :----------------------------------------------------------------------------------------------------- |
  | ngsi_auth         | 以下の設定パラメータを配列で保持                                                                       |
  | cert_type         | 認証タイプを設定<br> 固定のアクセストークンの場合は"static"を設定                                      |
  | domain            | NGSIサーバのドメイン名を記載 ポート指定を行う場合は":ポート番号"を合わせて記載                         |
  | auth              | NGSIサーバ へ API アクセスするためのアクセストークンを設定                                             |

  (2-2) 認証サーバからClient Credentials Grant認証でアクセストークンを取得し、NGSIサーバに接続する場合

  | 設定パラメータ    | 概要                                                                                                   |
  | :---------------- | :----------------------------------------------------------------------------------------------------- |
  | ngsi_auth         | 以下の設定パラメータを配列で保持                                                                       |
  | cert_type         | 認証タイプを設定<br>  Client Credentials Grant認証でアクセストークンの場合は"client_credential"を設定  |
  | domain            | NGSIサーバのドメイン名を記載する ポート指定を行う場合は":ポート番号"を合わせて記載                     |
  | certification_url | 認証認可サーバ（WSO2）のAPIエンドポイントのURLを設定                                                   |
  | client_id         | 認可サーバで使用するアプリクライアントのクライアントIDを設定                                           |
  | client_secret     | 認可サーバで使用するアプリクライアントのクライアントシークレットを設定                                 |
  
  (2-3) 認証サーバからResource Owner Password Credentials Grant認証でアクセストークンを取得し、NGSIサーバに接続する場合

  | 設定パラメータ    | 概要                                                                                                           |
  | :---------------- | :------------------------------------------------------------------------------------------------------------- |
  | ngsi_auth         | 以下の設定パラメータを配列で保持                                                                               |
  | cert_type         | 認証タイプを設定<br> Resource Owner Password Credentials Grant認証でアクセストークンの場合は"password"を設定   |
  | domain            | NGSIサーバのドメイン名を記載する ポート指定を行う場合は":ポート番号"を合わせて記載                             |
  | certification_url | 認証認可サーバ（WSO2）のAPIエンドポイントのURLを設定                                                           |
  | client_id         | 認可サーバで使用するアプリクライアントのクライアントIDを設定                                                   |
  | client_secret     | 認可サーバで使用するアプリクライアントのクライアントシークレットを設定                                         |
  | user_id           | 認可サーバで使用するアプリクライアントのユーザIDを設定                                                         |
  | user_pw           | 認可サーバで使用するアプリクライアントのパスワードを設定                                                       |


(2) NGSIデータの取得設定<br>

  | 設定パラメータ    | 概要                                                                                                   |
  | :---------------- | :----------------------------------------------------------------------------------------------------- |
  | entities_limit    | データモデルの作成時に取得するNGSIデータ(Entities)の件数を設定する。省略時は20件とする。               |
  | types_limit       | データモデルの作成時に取得するNGSIデータ(Types)の件数を設定する。省略時は100件とする。                 |

