# 「データカタログ作成ツール」の設定ファイル変更・ツール起動手順

<br>

# 1. カタログ作成ツール取得
```
$ git clone https://github.com/CADDE-sip/catalog_tool
```


# 2. アプリケーションサーバの設定ファイルの変更
対象ファイル： ./volumes/catalog_tool_flask/code/config.json
- config.json
  <br>./volumes/catalog_tool_flask/code/<br>

(1) 横断検索用CKANの設定

  | 設定パラメータ			| 概要																														|
  | :-----------------------| :------------------------------------------------------------------------------------------------------------------------ |
  | ckan_info				| 接続先CKAN情報を連想配列で保持																							|
  | release					| 接続先横断検索用CKAN情報を連想配列で保持																					|
  | ckan_url				| 横断検索用CKANのURLを設定																									|
  | sysadmin_key			| 横断検索用CKANサイトの運用管理者用APIキー を設定（CKAN認証で提供者ユーザでログインする場合は提供者ユーザのAPIキーを設定）	|
  | authentication			| 横断検索用CKANユーザの認証拡張の有無を設定																				|
  | authentication_method	| 横断検索用CKANユーザの認証拡張時の認証方式を設定																			|

(2) 詳細検索用CKANの設定 
  | 設定パラメータ			| 概要																														|
  | :---------------------- | :------------------------------------------------------------------------------------------------------------------------ |
  | ckan_info				| 接続先CKAN情報を連想配列で保持																							|
  | detail					| 接続先詳細検索用CKAN情報を連想配列で保持																					|
  | ckan_url				| 詳細検索用CKANのURLを設定																									|
  | sysadmin_key			| 詳細検索用CKANサイトの運用管理者用APIキーを設定（CKAN認証で提供者ユーザでログインする場合は提供者ユーザのAPIキーを設定）	|
  | authentication			| 詳細検索用CKANユーザの認証拡張の有無を設定																				|
  | authentication_method	| 詳細検索用CKANユーザの認証拡張時の認証方式を設定																			|

(3) カタログ作成ツール運用管理者ユーザの設定
  | 設定パラメータ		| 概要																																					|
  | :------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------- |
  | sysadmin			| カタログ作成ツールの運用管理者ユーザ情報を連想配列で保持																								|
  | cadde_user_id		| 運用管理者ユーザに紐づくCADDEユーザIDを設定（配列、複数設定可、CKAN認証で提供者ユーザでログインする場合は提供者ユーザに紐づくCADDEユーザIDを設定）	|
  | ckan_username		| 運用管理者ユーザのCKANユーザネームを設定（CKAN認証で提供者ユーザでログインする場合は提供者ユーザのCKANユーザネームを設定）							|
  | ckan_user_password	| 運用管理者ユーザのCKANユーザパスワードを設定（CKAN認証で提供者ユーザでログインする場合は提供者ユーザのCKANユーザパスワーを設定）						|

(4) geonames利用の設定
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | geonames			| 外部サービスgeonameの設定情報を連想配列で保持	(未サポート:false固定)															|
  | use_geonames		| geonamesの利用有無(データセットの対象地域の検索機能利用有無)を設定（true|false）							|
  | username			| geonamesのユーザネームを設定（use_geonamesがtrueの場合必須）												|

(5) 機械学習利用の設定
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | machine_learn		| 機械学習の設定情報を連想配列で保持(未サポート:false固定)																	|
  | theme				| 主分類分析機能の利用有無を設定（true/false）																|
  | keyword				| キーワード分析機能の利用有無を設定（true/false）															|
  | spatial				| 地域分析機能の利用有無を設定（true/false）																|
  | temporal			| 日時分析機能の利用有無を設定（true/false)																	|

(6) 来歴管理サーバの設定
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | history_url			| 来歴管理サーバのURLを設定																					|

(7) カタログ作成ツール内コンテナの設定
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | server				| カタログ作成ツール内のコンテナ情報を連想配列で保持														|
  | ngsi				| NGSI連携コンテナのコンテナ名を設定																		|
  | grpc				| 機械学習コンテナ名を設定(未サポート)																					|
  | ckan_authentication	| 認証拡張コンテナ情報を連想配列で保持。{"(認証方式)": "(認証コンテナ名)"}									|

(8) 認証サーバの設定
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | authorization		| 認証サーバへのアクセス情報を連想配列で保持（認証サーバを介してログインしない場合は設定不要）				|
  | auth_server_url		| 認証サーバのURLを設定																						|
  | keycloak_endpoint	| keycloak画面のエンドポイント																				|
  | client_id			| 認証サーバで登録済みのクライアントIDを設定																|
  | client_secret		| 認証サーバで登録済みのクライアントシークレットを設定														|

(9) カタログ作成ツール内データベースの設定
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | postgres			| カタログ作成ツール内で使用するデータベース情報を連想配列で保持											|
  | dialect				| データベースのダイアレクトを設定																			|
  | driver				| データベースドライバを設定																				|
  | username			| データベースアクセス時のユーザネームを設定																|
  | password			| データベースアクセス時のユーザパスワードを設定															|
  | host				| データベースコンテナのホスト名を設定																		|
  | port				| データベースコンテナのポート番号を設定																	|
  | database			| アクセスするデータベース名を指定																			|

(10) データ概要情報のファイル提供（HTTP）時における認証情報設定
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | http_auth			| アプリケーションサーバが使用するファイル提供（HTTP）の認証情報を配列で保持								|
  | url					| HTTPファイル取得先URLを設定																				|
  | id					| HTTPファイルを取得する際の認証IDを設定																	|
  | pass				| HTTPファイルを取得取得する際の認証パスを設定																|
  | proxy				| proxy経由の有無を設定																						|

  ※HTTPのプロキシ情報はHTTP_PROXY環境設定を事前に設定しておく必要があります。

(11) データ概要情報のファイル提供（FTP）時における認証情報設定
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | ftp_auth			| アプリケーションサーバが使用するファイル提供（FTP）の認証情報を配列で保持									|
  | url					| FTPファイル取得先URLを設定																				|
  | id					| FTPファイルを取得する際の認証IDを設定																		|
  | pass				| FTPファイルを取得する際の認証パスを設定																	|

<br>

# 3．NGSI連携コンテナサーバの設定ファイルの変更
  NGSIサーバへアクセスするための設定をコンフィグファイルに記載します。
- config.json
  <br>./volumes/catalog_tool_ngsi/swagger_server/configs<br>

(1) NGSIデータの取得設定<br>
  | 設定パラメータ		| 概要																											|
  | :-----------------  | :-------------------------------------------------------------------------------------------------------- 	|
  | entities_limit		| データモデルの作成時に取得するNGSIデータ(Entities)の件数を設定（省略時は20件）								|
  | types_limit			| データモデルの作成時に取得するNGSIデータ(Types)の件数を設定（省略時は100件）									|

(2) NGSIサーバの認証方法の設定およびNGSIデータの取得設定<br>
(2-1) 固定のアクセストークンでNGSIサーバに接続する場合

  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | ngsi_auth			| NGSIサーバへのアクセス情報を配列で保持																	|
  | cert_type			| 認証タイプを設定<br> 固定のアクセストークンの場合は"static"を設定											|
  | endpoint_url		| NGSIサーバのエンドポイントURLを設定																		|
  | auth				| NGSIサーバ へ API アクセスするためのアクセストークンを設定												|

(2-2) 認証サーバからClient Credentials Grant認証でアクセストークンを取得し、NGSIサーバに接続する場合
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | ngsi_auth			| NGSIサーバへのアクセス情報を配列で保持																	|
  | cert_type			| 認証タイプを設定<br>  Client Credentials Grant認証でアクセストークンの場合は"client_credential"を設定		|
  | endpoint_url		| NGSIサーバのエンドポイントURLを設定																		|
  | certification_url	| 認証認可サーバ（WSO2）のAPIエンドポイントのURLを設定														|
  | client_id			| 認可サーバで使用するアプリクライアントのクライアントIDを設定												|
  | client_secret		| 認可サーバで使用するアプリクライアントのクライアントシークレットを設定									|

(2-3) 認証サーバからResource Owner Password Credentials Grant認証でアクセストークンを取得し、NGSIサーバに接続する場合
  | 設定パラメータ		| 概要																											|
  | :-----------------  | :-------------------------------------------------------------------------------------------------------- 	|
  | ngsi_auth			| NGSIサーバへのアクセス情報を配列で保持																		|
  | cert_type			| 認証タイプを設定<br> Resource Owner Password Credentials Grant認証でアクセストークンの場合は"password"を設定	|
  | endpoint_url		| NGSIサーバのエンドポイントURLを設定																			|
  | certification_url	| 認証認可サーバ（WSO2）のAPIエンドポイントのURLを設定															|
  | client_id			| 認可サーバで使用するアプリクライアントのクライアントIDを設定													|
  | client_secret		| 認可サーバで使用するアプリクライアントのクライアントシークレットを設定										|
  | user_id				| 認可サーバで使用するアプリクライアントのユーザIDを設定														|
  | user_pw				| 認可サーバで使用するアプリクライアントのパスワードを設定														|

<br>

# 5. 認証拡張コンテナの設定ファイルの変更
  認証拡張機能を使用してCKANユーザを認証するための設定をコンフィグファイルに記載します。

(3-1)OAuth2認証拡張コンテナのコンフィグ設定
- config.json
  <br>./volumes/catalog_tool_authentication_oauth2/swagger_server/configs
  | 設定パラメータ		| 概要																										|
  | :------------------ | :-------------------------------------------------------------------------------------------------------- |
  | oauth2_auth			| OAuth2で認証するユーザ情報と認証情報をCKANユーザごとに連想配列で保持										|
  | ckan_url			| 認証対象のCKAN URLを設定																					|
  | username			| 認証対象のCKANユーザ名を設定																				|
  | auth_type			| 認証方式を設定(client_credential/password)																|
  | authentication_url	| 認証サーバのAPIエンドポイントのURLを設定																	|
  | password			| 認証対象のCKANのログインパスワードを設定(認証方式がResource Owner Credentials Grantの場合のみ設定が必要)	|
  | client_id			| 認証対象のCKANユーザに紐づくクライアントIDを設定															|
  | client_secret		| 認証対象のCKANユーザに紐づくクライアントシークレットを設定												|

<br>


# 6. docker networkの作成

```
$ sodu docker network create provider
```

# 7．サービス起動
```
$ sudo sh ./start.sh
```

# 8．サービス起動確認

```
$ sudo docker compose -f docker-compose.yml ps
```

コマンド結果
<br>
```
NAME                                 COMMAND                  SERVICE                              STATUS              PORTS
catalog-tool-authentication-oauth2   "python3 -m swagger_…"   catalog_tool_authentication_oauth2   running             8080/tcp
catalog-tool-flask                   "gunicorn app:app -b…"   catalog_tool_flask                   running             0.0.0.0:18000->18000/tcp, :::18000->18000/tcp
catalog-tool-ngsi                    "python3 -m swagger_…"   catalog_tool_ngsi                    running             8080/tcp
catalog-tool-postgres                "docker-entrypoint.s…"   catalog_tool_postgres                running             5432/tcp
catalog-tool-web                     "/docker-entrypoint.…"   nginx                                running             0.0.0.0:8000->8000/tcp, :::8000->8000/tcp
```

# 9．ツール使用手順

1. Webブラウザから本ツールのサイトにアクセスする(例: http://[本ツールのIPアドレス]:8000)
2. トップ画面より、画面下部の「ログインページへ」ボタンを押下する
3. keycloakログイン画面より、CADDEユーザID・CADDEユーザパスワードを入力し、「Sign In」ボタンを押下する(CADDEユーザIDとCKANユーザ情報を事前に紐づけておくこと)
4. カタログ本体画面が開くことを確認する
<br>

# 10.サービス停止

```
$ sudo sh ./stop.sh
```
<br>

## 問い合わせ先
問い合わせ窓口：ml_bunyakan_dl@ml.itg.hitachi.co.jp <br><br>
